<html>
<head>
    <style type="text/css">

        html, body, #map {
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        #map {
            display: block;
        }

    </style>
    <script type="text/javascript" src="jquery-3.2.1.js"></script>
    <script type="text/javascript" src="jquery.mousewheel.js"></script>
    <script type="text/javascript" src="general.js"></script>
    <script type="text/javascript" src="map.js"></script>
    <script type="text/javascript">
        $(function() {

            //
            // create the map
            //

            map = new AwesomeMap.Map($('#map')[0]);
            map.layers[0] = new AwesomeMap.Layer();
            map.installResizer(function(canvas) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });


            //
            // zooming
            //

            (function() {

                $('#map').on('mousewheel', function(event) {
                    var factor = Math.exp(event.deltaY * event.deltaFactor / 1000);
                    map.viewport.zoomAtPixelPosition(event.pageX, event.pageY, factor);
                });

            })();


            //
            // panning
            //

            (function() {

                $('#map').awesomeDrag(function(dx, dy) {
                    map.viewport.panByPixelAmount(dx, dy);
                });

                $('#map').on('contextmenu', function(event) {
                    var screenPoint = {x: event.pageX, y: event.pageY};
                    var mapPoint = map.viewport.untransformPoint(screenPoint);
                    map.layers[0].objects.push({
                        x: mapPoint.x,
                        y: mapPoint.y,
                        r: 100
                    });
                    map.render();
                    return false;
                });

            })();


            //
            // initialization
            //

            for (i=0; i<10000; i++) {
                map.layers[0].objects.push({
                    x: Math.random() * 100000 - 50000,
                    y: Math.random() * 100000 - 50000,
                    r: Math.random() * 50 + 100
                });
            }

            // TODO optimization test
            if (false) {
                var oldLayer0 = map.layers[0];
                var bufferCanvas = null;
                var bufferContext = null;
                var bufferCounter = 0;
                var bufferTransformation = null;
                map.layers[0] = {
                    render: function(context, viewport) {

                        // first, simple optimization: rate-limit the actual drawing and just pan/zoom and old rendering
                        // in between.
                        // result: not really good because the re-rendering doesn't happen in the background, so when
                        // it happens there are noticeable stops.
                        // Web workers won't help: A WW could filter the visible set, but if the visible set is large,
                        // all those objects must still be rendered (in the main thread).
                        //
                        // Solution to this problem: Build an offscreen canvas in the worker and transfer image data
                        // as in https://stackoverflow.com/questions/1864756/web-workers-and-canvas
                        //

                        // initialization
                        if (!bufferCanvas) {
                            bufferCanvas = document.createElement('canvas');
                            bufferCanvas.width = context.canvas.width;
                            bufferCanvas.height = context.canvas.height;
                            bufferContext = bufferCanvas.getContext('2d');
                        }

                        // rendering
                        if (bufferCounter < 1) {
                            bufferCounter = 10;

                            // clear buffer to transparent
                            bufferContext.setTransform(1, 0, 0, 1, 0, 0);
                            bufferContext.clearRect(0, 0, bufferCanvas.width, bufferCanvas.height);

                            // render to buffer
                            bufferContext.fillStyle = '#0000ff';
                            bufferContext.setTransform(1, 0, 0, 1, 0, 0);
                            viewport.applyToContext(bufferContext);
                            oldLayer0.render(bufferContext, viewport);

                            // remember the current transformation to compute deltas later
                            bufferTransformation = viewport.cloneForTransformation();

                        } else {
                            bufferCounter--;
                        }

                        // render the buffer onto the real canvas
                        context.save();
                        context.setTransform(1, 0, 0, 1, 0, 0);
                        viewport.applyDeltaToContext(context, bufferTransformation);
                        context.drawImage(bufferCanvas, 0, 0);
                        context.restore();

                    }
                };
            }

            map.render();

        });
    </script>
</head>
<body>
    <canvas id="map"></canvas>
</body>
</html>