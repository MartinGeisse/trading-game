<html>
<wicket:head>
    <style type="text/css">

        #context-menu {
            position: absolute;
            display: none;
        }

        #propertiesBox {
            visibility: hidden;
            position: absolute;
            width: 300px;
            height: 150px;
            right: 20px;
            bottom: 20px;
            z-index: 1;
            background-color: #002040;
            border: 1px solid #40b0b0;
            padding: 5px;
        }

        #propertiesBox.hasSelectedSpaceObject {
            visibility: visible;
        }

        .propertiesBoxToolbar {
            margin-top: 5px;
        }

        .propertiesBoxToolbar .tool {
            border: 1px solid #40b0b0;
            background-color: #004040;
            padding: 4px 3px 3px;
            width: 20px;
            height: 20px;
            text-align: center;
            color: white;
        }

    </style>
    <script type="text/javascript">
        latestDynamicSpaceObjectsUpdateTimestamp = new Date().getTime();
        initializeMapSectionPanel = function() {
            $(function() {

                map = new AwesomeMap.Map($('#map')[0]);
                selectionIndicatorLayer = new AwesomeMap.Layer();
                selectionIndicatorLayer.renderer = function(context, viewport, object) {
                    context.fillStyle = '#008000';
                    context.strokeStyle = '#00ff00';
                    context.lineWidth = map.viewport.untransformDistance(2);
                    context.beginPath();
                    context.arc(object.x, object.y, object.mapRadius + viewport.untransformDistance(object.pixelRadius), 0, 2 * Math.PI);
                    context.fill();
                    context.stroke();
                };
                staticSpaceObjectsLayer = new AwesomeMap.Layer();
                staticSpaceObjectsLayer.renderer = function(context, viewport, object) {
                    context.fillStyle = object.c;
                    context.beginPath();
                    context.arc(object.x, object.y, object.r, 0, 2 * Math.PI);
                    context.fill();
                };
                dynamicSpaceObjectsLayer = new AwesomeMap.Layer();
                dynamicSpaceObjectsLayer.renderer = function(context, viewport, object) {

                /*
                    var secondsSinceLatestDynamicSpaceObjectsUpdate = (new Date().getTime() - latestDynamicSpaceObjectsUpdateTimestamp) / 1000;
                    var spaceObjectsParentSelection = createSpaceObjectsParent(selection, projection);
                    var updateSelection = spaceObjectsParentSelection.selectAll('*').data(dynamicSpaceObjects);
                    updateSelection.enter().append('circle')
                        .attr("style", "stroke-width: 0px")
                        .merge(updateSelection)
                        .attr("r", function(d) {return d.r;})
                        .style("fill", function(d) {return d.c;})
                        .each(function(d, index) {
                            if (('x2' in d) && ('y2' in d) && ('t' in d) && (d.t > 0)) {
                                var alpha = secondsSinceLatestDynamicSpaceObjectsUpdate / d.t;
                                if (alpha >= 1) {
                                    d3.select(this).attr("cx", d.x2).attr("cy", d.y2);
                                } else {
                                    d3.select(this)
                                        .attr("cx", alpha * d.x2 + (1 - alpha) * d.x)
                                        .attr("cy", alpha * d.y2 + (1 - alpha) * d.y);
                                }
                            } else {
                                d3.select(this).attr("cx", d.x).attr("cy", d.y);
                            }
                        });
*/

                    context.fillStyle = object.c;
                    context.beginPath();
                    context.arc(object.x, object.y, object.r, 0, 2 * Math.PI);
                    context.fill();
                };
                map.layers = [selectionIndicatorLayer, staticSpaceObjectsLayer, dynamicSpaceObjectsLayer];
                map.installResizer(function(canvas) {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                });







                // set defaults for global variables
                spaceObjectSelectionIndicator = null;
                leafletMap = null;

                // create a map with the tile layer coming from our server
                leafletMap = L.map('map', {
                    crs: L.CRS.SimpleNonInverted,
                    fadeAnimation: false,
                    updateInterval: 0,
                    edgeBufferTiles: 1,
                    // maxZoom: 4
                });
                L.tileLayer(mapTileBaseUrl + '?x={x}&y={y}&z={z}', {
                    continuousWorld: true,
                    noWrap: true,
                    // maxZoom: 3,
                    bounds: L.latLngBounds(L.latLng(0, 0), L.latLng(256, 256)),
                }).addTo(leafletMap);

                // re-render periodically to animate dynamic space objects
                setInterval(function() {
                    map.render();
                }, 100);

                // clicking selects an object. Finding the object is done on the server -- this needs the current zoom
                // level to determine the search radius.
                leafletMap.on('click', function(e) {
                    sendMapClickCommand(e.latlng.lat, e.latlng.lng, leafletMap.getZoom());
                });

                // right-clicking (long-press on mobile) opens a context menu, but again we must first search for the object
                leafletMap.on('contextmenu', function(e) {
                    sendMapMenuCommand(e.latlng.lat, e.latlng.lng, leafletMap.getZoom(), e.originalEvent.pageX, e.originalEvent.pageY);
                });

                removeSpaceObjectSelectionIndicator = function() {
                    if (spaceObjectSelectionIndicator != null) {
                        spaceObjectSelectionIndicator.remove();
                    }
                };
                changeSpaceObjectSelectionIndicator = function(lat, lng, radius) {
                    removeSpaceObjectSelectionIndicator();
                    spaceObjectSelectionIndicator = new HybridCircle(L.latLng(lat, lng), {latLngRadius: radius, pixelRadius: 10});
                    spaceObjectSelectionIndicator.addTo(leafletMap);
                };

                $(document).on('click', '#selectOwnShipLink', function() {
                    sendSelectOwnShipCommand();
                    return false;
                });
                $(document).on('click', '#centerSelectedObjectLink', function() {
                    if (spaceObjectSelectionIndicator != null) {
                        leafletMap.flyTo(spaceObjectSelectionIndicator.getLatLng());
                    }
                    return false;
                });
                $(document).on('click contextmenu', '#map, #propertiesBox', function() {
                    $('#context-menu').css('display', 'none');
                });

                // restore previous position and zoom
                oldState = getStateCookie('mapState');
                if (oldState) {
                    leafletMap.setView(L.latLng(oldState.lat, oldState.lng), oldState.zoom);
                } else {
                    leafletMap.setView([128, 128], 1);
                }
                oldSelectedId = getStateCookie('mapSelection');
                if (oldSelectedId) {
                    sendSelectByIdCommand(oldSelectedId);
                }

                // save position/zoom changes from here
                leafletMap.on('moveend', function (e) {
                    if (this._loaded) {
                        setStateCookie('mapState', {
                            lat: this.getCenter().lat,
                            lng: this.getCenter().lng,
                            zoom: this.getZoom()
                        });
                    }
                }, leafletMap);

            });

        };
        updateDynamicSpaceObjectsOnMap = function() {
            latestDynamicSpaceObjectsUpdateTimestamp = new Date().getTime();
            dynamicSpaceObjectsLayer.objects = dynamicSpaceObjects;
            map.render();
        };
    </script>
</wicket:head>
<body>
<wicket:panel>
    <canvas id="map" style="display: block; margin: 0px; padding: 0px; z-index: 0; "></canvas>
    <ul class="dropdown-menu" id="context-menu">
        <li><a href="#">Action</a></li>
        <li><a href="#">Another action</a></li>
        <li><a href="#">Something else here</a></li>
        <li role="separator" class="divider"></li>
        <li><a href="#">Separated link</a></li>
    </ul>
    <div style="position: absolute; left: 20px; bottom: 20px; z-index: 1"><a href="#" id="selectOwnShipLink">select own
        ship</a></div>
    <div id="propertiesBox" wicket:id="propertiesBox">
        <div><span wicket:id="name"></span> (<span wicket:id="type"></span>)</div>
        <div>Location: <span wicket:id="x"></span>, <span wicket:id="y"></span></div>
        <div>Distance: <span wicket:id="distance"></span></div>
        <div class="propertiesBoxToolbar">
            <wicket:container wicket:id="actions">
                <a class="tool" wicket:id="link"><span wicket:id="icon"></span></a>
            </wicket:container>
            <a class="tool" href="#" id="centerSelectedObjectLink"><span class="glyphicon glyphicon-screenshot"></span></a>
            <a class="tool" wicket:id="spaceObjectDetailLink"><span class="glyphicon glyphicon-chevron-right"></span></a>
        </div>
    </div>
</wicket:panel>
</body>
</html>
