<html>
<wicket:head>
    <style type="text/css">

        #context-menu {
            position: absolute;
            display: none;
        }

        #propertiesBox {
            visibility: hidden;
        }

        #propertiesBox.hasSelectedSpaceObject {
            visibility: visible;
        }

    </style>
    <script type="text/javascript">
        initializeMapSectionPanel = function() {

            // set defaults for global variables
            spaceObjectSelectionIndicator = null;
            leafletMap = null;

            // use a simple coordinate system with a linear projection
            L.CRS.SimpleNonInverted = L.extend({}, L.CRS.Simple, {
                transformation: new L.Transformation(1, 0, 1, 0),
            });

            // support circles with a hybrid (game / pixel coordinate) radius
            HybridCircle = L.CircleMarker.extend({

                initialize: function (latlng, options) {
                    L.setOptions(this, options);
                    this._latlng = L.latLng(latlng);
                    this._latLngRadius = this.options.latLngRadius;
                    this._pixelRadius = this.options.pixelRadius;
                },

                // sets the latLng coordinate radius in lat/lng units
                setLatLngRadius: function (radius) {
                    this._latLngRadius = radius;
                    return this.redraw();
                },

                // gets the latLng coordinate radius in lat/lng units
                getLatLngRadius: function () {
                    return this._latLngRadius;
                },

                // sets the pixel coordinate radius in pixels
                setPixelRadius: function (radius) {
                    this._pixelRadius = radius;
                    return this.redraw();
                },

                // gets the pixel coordinate radius in pixels
                getPixelRadius: function () {
                    return this._pixelRadius;
                },

                // ...
                getBounds: function () {
                    var half = [this._radius, this._radiusY || this._radius];
                    return new L.LatLngBounds(
                        this._map.layerPointToLatLng(this._point.subtract(half)),
                        this._map.layerPointToLatLng(this._point.add(half)));
                },

                // ...
                setStyle: L.Path.prototype.setStyle,

                // ...
                _project: function () {
                    var map = this._map;
                    var crs = map.options.crs;
                    var latlng2 = crs.unproject(crs.project(this._latlng).subtract([this._latLngRadius, 0]));
                    this._point = map.latLngToLayerPoint(this._latlng);
                    this._radius = this._point.x - map.latLngToLayerPoint(latlng2).x + this._pixelRadius;
                    this._updateBounds();
                }

            });


            // create a map with the tile layer coming from our server
            leafletMap = L.map('map', {
                crs: L.CRS.SimpleNonInverted,
                // maxZoom: 4
            });
            L.tileLayer(mapTileBaseUrl + '?x={x}&y={y}&z={z}', {
                continuousWorld: true,
                noWrap: true,
                // maxZoom: 3,
                bounds: L.latLngBounds(L.latLng(0, 0), L.latLng(256, 256)),
            }).addTo(leafletMap);

            // show dynamic space objects in an SVG overlay
            var dynamicSpaceObjectsOverlay = L.d3SvgOverlay(function(selection, projection) {

                function createSpaceObjectsParent(selection, projection) {

                    // create our own main 'g' element as the sole child of D3SvgOverlay's main 'g' element, if missing
                    // selection.selectAll('g').data([1]).enter().append('g');
                    selection.selectAll('g').data([1]).enter().append('g');

                    // select that element
                    var spaceObjectsParentSelection = selection.select('g');

                    // configure the transformation
                    var originPoint = projection.latLngToLayerPoint(L.latLng(0, 0));
                    var latLngUnitPoint = projection.latLngToLayerPoint(L.latLng(1, 1));
                    var latLngUnit = latLngUnitPoint.x - originPoint.x;
                    spaceObjectsParentSelection.attr('transform', 'translate(' + originPoint.x + ',' + originPoint.y + ') scale(' + latLngUnit + ')');

                    return spaceObjectsParentSelection;
                }

                var spaceObjectsParentSelection = createSpaceObjectsParent(selection, projection);
                var updateSelection = spaceObjectsParentSelection.selectAll('*').data(dynamicSpaceObjectsData);
                updateSelection.enter().append('circle').attr("style", "stroke-width: 0px")
                    .merge(updateSelection)
                    .attr("cx", function(d) {return d.x;})
                    .attr("cy", function(d) {return d.y;})
                    .attr("r", function(d) {return d.r;})
                    .style("fill", function(d) {return d.c;});

            });
            dynamicSpaceObjectsOverlay.addTo(leafletMap);
            redrawDynamicSpaceObjects = function() {
                dynamicSpaceObjectsOverlay.draw();
            };

            // clicking selects an object. Finding the object is done on the server.
            leafletMap.on('click', function(e) {
                sendMapClickCommand(e.latlng.lat, e.latlng.lng, leafletMap.getZoom());
            });

            // right-clicking (long-press on mobile) opens a context menu, but again we must first search for the object
            leafletMap.on('contextmenu', function(e) {
                sendMapMenuCommand(e.latlng.lat, e.latlng.lng, leafletMap.getZoom(), e.originalEvent.pageX, e.originalEvent.pageY);
            });

            removeSpaceObjectSelectionIndicator = function() {
                if (spaceObjectSelectionIndicator != null) {
                    spaceObjectSelectionIndicator.remove();
                }
            };
            changeSpaceObjectSelectionIndicator = function(lat, lng, radius) {
                removeSpaceObjectSelectionIndicator();
                spaceObjectSelectionIndicator = new HybridCircle(L.latLng(lat, lng), {latLngRadius: radius, pixelRadius: 10});
                spaceObjectSelectionIndicator.addTo(leafletMap);
                // console.log(lat + ", " + lng);
            };

            $(document).on('click', '#selectOwnShipLink', function() {
                sendSelectOwnShipCommand();
            });
            $(document).on('click', '#centerSelectedObjectLink', function() {
                if (spaceObjectSelectionIndicator != null) {
                    leafletMap.flyTo(spaceObjectSelectionIndicator.getLatLng());
                }
            });
            $(document).on('click contextmenu', '#map, #propertiesBox', function() {
                $('#context-menu').css('display', 'none');
            });

            // restore previous position and zoom
            oldState = getStateCookie('mapState');
            if (oldState) {
                leafletMap.setView(L.latLng(oldState.lat, oldState.lng), oldState.zoom);
            } else {
                leafletMap.setView([128, 128], 1);
            }
            oldSelectedId = getStateCookie('mapSelection');
            if (oldSelectedId) {
                sendSelectByIdCommand(oldSelectedId);
            }

            // save position/zoom changes from here
            leafletMap.on('moveend', function (e) {
                if (this._loaded) {
                    setStateCookie('mapState', {
                        lat: this.getCenter().lat,
                        lng: this.getCenter().lng,
                        zoom: this.getZoom()
                    });
                }
            }, leafletMap);


        };
    </script>
</wicket:head>
<body>
    <wicket:panel>
        <div id="map" style="position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px; cursor: initial; z-index: 0"></div>
        <ul class="dropdown-menu" id="context-menu">
            <li><a href="#">Action</a></li>
            <li><a href="#">Another action</a></li>
            <li><a href="#">Something else here</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="#">Separated link</a></li>
        </ul>
        <div id="propertiesBox" wicket:id="propertiesBox" style="position: absolute; width: 400px; height: 400px; right: 0px; bottom: 0px; z-index: 1">
            <h2>Properties</h2>
            <div>Name: <span wicket:id="name"></span></div>
            <div>Type: <span wicket:id="type"></span></div>
            <div>Location: <span wicket:id="x"></span>, <span wicket:id="y"></span></div>
            <div>Distance: <span wicket:id="distance"></span></div>
            <h2>Actions</h2>
            <div wicket:id="actions">
                <a wicket:id="link"><span wicket:id="name"></span></a>
            </div>
            <div style="position: absolute; left: 0px; right: 0px; bottom: 0px; height: 100px; ">
                <div><a href="#" id="selectOwnShipLink">select own ship</a></div>
                <div><a href="#" id="centerSelectedObjectLink">center selected object</a></div>
            </div>
            <hr />

        </div>
    </wicket:panel>
</body>
</html>
