<html>
<wicket:head>
    <style type="text/css">

        #context-menu {
            position: absolute;
            display: none;
        }

        #propertiesBox {
            visibility: hidden;
            position: absolute;
            width: 300px;
            height: 150px;
            right: 20px;
            bottom: 20px;
            z-index: 1;
            background-color: #002040;
            border: 1px solid #40b0b0;
            padding: 5px;
        }

        #propertiesBox.hasSelectedSpaceObject {
            visibility: visible;
        }

        .propertiesBoxToolbar {
            margin-top: 5px;
        }

        .propertiesBoxToolbar .tool {
            border: 1px solid #40b0b0;
            background-color: #004040;
            padding: 4px 3px 3px;
            width: 20px;
            height: 20px;
            text-align: center;
            color: white;
        }

    </style>
    <script type="text/javascript">
        latestDynamicSpaceObjectsUpdateTimestamp = new Date().getTime();
        initializeMapSectionPanel = function() {
            $(function() {

                // create the map and its layers
                map = new AwesomeMap.Map($('#map')[0]);
                selectionIndicatorLayer = new AwesomeMap.Layer();
                selectionIndicatorLayer.renderer = function(context, viewport, object) {
                    context.fillStyle = '#008000';
                    context.strokeStyle = '#00ff00';
                    context.lineWidth = map.viewport.untransformDistance(2);
                    context.beginPath();
                    context.arc(object.x, object.y, object.mapRadius + viewport.untransformDistance(object.pixelRadius), 0, 2 * Math.PI);
                    context.fill();
                    context.stroke();
                };
                staticSpaceObjectsLayer = new AwesomeMap.Layer();
                staticSpaceObjectsLayer.renderer = function(context, viewport, object) {
                    context.fillStyle = object.c;
                    context.beginPath();
                    context.arc(object.x, object.y, object.r, 0, 2 * Math.PI);
                    context.fill();
                };
                dynamicSpaceObjectsLayer = new AwesomeMap.Layer();
                dynamicSpaceObjectsLayer.onBeforeRender = function(context, viewport) {
                    this.secondsSinceLatestDynamicSpaceObjectsUpdate = (new Date().getTime() - latestDynamicSpaceObjectsUpdateTimestamp) / 1000;
                };
                dynamicSpaceObjectsLayer.renderer = function(context, viewport, object) {
                    var x, y;
                    if (('x2' in object) && ('y2' in object) && ('t' in object) && (object.t > 0)) {
                        var alpha = this.secondsSinceLatestDynamicSpaceObjectsUpdate / object.t;
                        if (alpha >= 1) {
                            x = object.x2;
                            y = object.y2;
                        } else {
                            x = alpha * object.x2 + (1 - alpha) * object.x);
                            y = alpha * object.y2 + (1 - alpha) * object.y);
                        }
                    } else {
                        x = object.x;
                        y = object.y;
                    }
                    context.fillStyle = object.c;
                    context.beginPath();
                    context.arc(x, y, object.r, 0, 2 * Math.PI);
                    context.fill();
                };
                map.layers = [selectionIndicatorLayer, staticSpaceObjectsLayer, dynamicSpaceObjectsLayer];
                map.installResizer(function(canvas) {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                });

                // re-render periodically to animate dynamic space objects
                setInterval(function() {
                    map.render();
                }, 100);

                // Clicking selects an object. At least for dynamic space objects, finding the target object must happen
                // on the client-side to handle moving dynamic space objects properly -- the delay between client and
                // server would make this unreliable. For static space objects, we can do the same for simiplicity IF
                // we restrict the search to the visible set of space objects (otherwise it takes too long).
                //
                // TODO currently uses 'contextmenu' event since we cannot distinguish left-clicking from dragging yet
                //
                leafletMap.on('contextmenu', function(event) {
                    selectionIndicatorLayer.objects = [];
                    var point = map.viewport.untransformMouseEvent(event);
                    var clickRadius = map.viewport.untransformDistance(selectionDistance);
                    var clickTargetLayers = [staticSpaceObjectsLayer, dynamicSpaceObjectsLayer];
                    layerLoop: for (i in clickTargetLayers) {
                        var clickTargetLayer = clickTargetLayers[i];
                        for (var j in clickTargetLayer.objects) {
                            var object = clickTargetLayer.objects[j];
                            var maxDistance = clickRadius + object.r;
                            var dx = (point.x - object.x);
                            if (dx > maxDistance || dx < -maxDistance) {
                                continue;
                            }
                            var dy = (point.y - object.y);
                            if (dy > maxDistance || dy < -maxDistance) {
                                continue;
                            }
                            if (dx * dx + dy * dy <= maxDistance * maxDistance) {
                                // TODO find nearest one in case of multiple matches
                                selectionIndicatorLayer.objects = [{
                                    x: object.x,
                                    y: object.y,
                                    mapRadius: object.r,
                                    pixelRadius: selectionDistance,
                                }];
                                break;
                            }
                        }
                    }
                    map.render();
                    // TODO send command to server to select this object; while that request loads, clear the property box (loading indicator!)
                    return false;
                });

                // right-clicking (long-press on mobile) opens a context menu, but again we must first search for the object
                // TODO commented because "clicking" uses a right-click. Should share code and just send a different command
                // leafletMap.on('contextmenu', function(e) {
                //    sendMapMenuCommand(e.latlng.lat, e.latlng.lng, leafletMap.getZoom(), e.originalEvent.pageX, e.originalEvent.pageY);
                //});
                //$(document).on('click contextmenu', '#map, #propertiesBox', function() {
                //    $('#context-menu').css('display', 'none');
                //});

                // TODO these functions must be replaced by a better system. The server cannot set the position for the
                // indicator because of moving dynamic space objects, but may have to trigger setting the indicator for
                // select-by-id (e.g. select own ship). For moving objects, it is more useful to allow a moving indicator
                // or possibly a position-less indicator that references the selected space object. This would have to use
                // a symbolic reference such that during server-reloads of the list of dynamic space objects, the
                // reference doesn't get broken.
                removeSpaceObjectSelectionIndicator = function() {
                    // selectionIndicatorLayer.objects = [];
                };
                changeSpaceObjectSelectionIndicator = function(lat, lng, radius) {
                    // removeSpaceObjectSelectionIndicator();
                    // spaceObjectSelectionIndicator = new HybridCircle(L.latLng(lat, lng), {latLngRadius: radius, pixelRadius: 10});
                    // spaceObjectSelectionIndicator.addTo(leafletMap);
                };

                // utility links
                $(document).on('click', '#selectOwnShipLink', function() {
                    // TODO show loading indicator in the properties panel
                    sendSelectOwnShipCommand();
                    return false;
                });
                $(document).on('click', '#centerSelectedObjectLink', function() {
                    // TODO
                    return false;
                });

                // restore previous position and zoom
                oldState = getStateCookie('mapState');
                if (oldState) {
                    map.viewport.mapOriginX = oldState.mapOriginX;
                    map.viewport.mapOriginY = oldState.mapOriginY;
                    map.viewport.zoom = oldState.zoom;
                } else {
                    map.viewport.mapOriginX = 0;
                    map.viewport.mapOriginY = 0;
                    map.viewport.zoom = 1;
                }
                oldSelectedId = getStateCookie('mapSelection');
                if (oldSelectedId) {
                    sendSelectByIdCommand(oldSelectedId);
                }

                // save position/zoom changes from here
                map.viewport.onChange = function() {
                    setStateCookie('mapState', {
                        mapOriginX: map.viewport.mapOriginX,
                        mapOriginY: map.viewport.mapOriginY,
                        zoom: map.viewport.zoom,
                    });
                };

                map.render();
            });
        };
        updateDynamicSpaceObjectsOnMap = function() {
            latestDynamicSpaceObjectsUpdateTimestamp = new Date().getTime();
            dynamicSpaceObjectsLayer.objects = dynamicSpaceObjects;
            map.render();
        };
    </script>
</wicket:head>
<body>
<wicket:panel>
    <canvas id="map" style="display: block; margin: 0px; padding: 0px; z-index: 0; "></canvas>
    <ul class="dropdown-menu" id="context-menu">
        <li><a href="#">Action</a></li>
        <li><a href="#">Another action</a></li>
        <li><a href="#">Something else here</a></li>
        <li role="separator" class="divider"></li>
        <li><a href="#">Separated link</a></li>
    </ul>
    <div style="position: absolute; left: 20px; bottom: 20px; z-index: 1"><a href="#" id="selectOwnShipLink">select own
        ship</a></div>
    <div id="propertiesBox" wicket:id="propertiesBox">
        <div><span wicket:id="name"></span> (<span wicket:id="type"></span>)</div>
        <div>Location: <span wicket:id="x"></span>, <span wicket:id="y"></span></div>
        <div>Distance: <span wicket:id="distance"></span></div>
        <div class="propertiesBoxToolbar">
            <wicket:container wicket:id="actions">
                <a class="tool" wicket:id="link"><span wicket:id="icon"></span></a>
            </wicket:container>
            <a class="tool" href="#" id="centerSelectedObjectLink"><span class="glyphicon glyphicon-screenshot"></span></a>
            <a class="tool" wicket:id="spaceObjectDetailLink"><span class="glyphicon glyphicon-chevron-right"></span></a>
        </div>
    </div>
</wicket:panel>
</body>
</html>
