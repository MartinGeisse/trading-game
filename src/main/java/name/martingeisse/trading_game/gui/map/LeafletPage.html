<html>
<wicket:head>
    <script type="text/javascript">

        spaceObjectSelectionIndicator = null;
        leafletMap = null;
        dynamicSpaceObjectsData = [
            {x: 0, y: 0, r: 50},
            {x: 128, y: 0, r: 30},
        ];

        $(function() {

            var dynamicSpaceObjectsOverlay;

            L.CRS.SimpleNonInverted = L.extend({}, L.CRS.Simple, {
                transformation: new L.Transformation(1, 0, 1, 0),
            });
            leafletMap = L.map('map', {
                crs: L.CRS.SimpleNonInverted,
                // maxZoom: 4
            }).setView([0, 0], 10);
            L.tileLayer(mapTileBaseUrl + '?x={x}&y={y}&z={z}', {
                continuousWorld: true,
                noWrap: true,
                // maxZoom: 3,
                bounds: L.latLngBounds(L.latLng(0, 0), L.latLng(256, 256)),
            }).addTo(leafletMap);
            leafletMap.on('click', function(e) {
                sendMapClickCommand(e.latlng.lat, e.latlng.lng, leafletMap.getZoom()); // TODO check lat/lng order
            });

            // SVG test
            dynamicSpaceObjectsOverlay = L.d3SvgOverlay(function(selection, projection) {

                function createSpaceObjectsParent(selection, projection) {

                    // create our own main 'g' element as the sole child of D3SvgOverlay's main 'g' element, if missing
                    // selection.selectAll('g').data([1]).enter().append('g');
                    selection.selectAll('g').data([1]).enter().append('g');

                    // select that element
                    var spaceObjectsParentSelection = selection.select('g');

                    // configure the transformation
                    var originPoint = projection.latLngToLayerPoint(L.latLng(0, 0));
                    var latLngUnitPoint = projection.latLngToLayerPoint(L.latLng(1, 1));
                    var latLngUnit = latLngUnitPoint.x - originPoint.x;
                    spaceObjectsParentSelection.attr('transform', 'translate(' + originPoint.x + ',' + originPoint.y + ') scale(' + latLngUnit + ')');

                    return spaceObjectsParentSelection;
                }

                var spaceObjectsParentSelection = createSpaceObjectsParent(selection, projection);
                var updateSelection = spaceObjectsParentSelection.selectAll('*').data(dynamicSpaceObjectsData);
                updateSelection.enter().append('circle').attr("style", "stroke:#ff0000; fill: #0000ff")
                    .merge(updateSelection)
                    .attr("cx", function(d) {return d.x;})
                    .attr("cy", function(d) {return d.y;})
                    .attr("r", function(d) {return d.r;});

            });
            dynamicSpaceObjectsOverlay.addTo(leafletMap);
            redrawDynamicSpaceObjects = function() {
                dynamicSpaceObjectsOverlay.draw();
            };

            // TODO test, remove
            setInterval(function() {
                dynamicSpaceObjectsData[0].x++;
                redrawDynamicSpaceObjects();
            }, 100);

        });

        changeSpaceObjectSelectionIndicator = function(lat, lng, radius) {
            if (spaceObjectSelectionIndicator != null) {
                spaceObjectSelectionIndicator.remove();
            }
            spaceObjectSelectionIndicator = L.circle(L.latLng(lat, lng), {radius: radius});
            spaceObjectSelectionIndicator.addTo(leafletMap);
            // console.log(lat + ", " + lng);
        };

    </script>
</wicket:head>
<body>
    <div id="map" style="position: fixed; top: 0px; bottom: 0px; left: 0px; right: 0px; cursor: initial; "></div>
</body>
</html>
